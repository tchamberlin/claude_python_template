ARG PYTHON_VERSION=3.13
FROM docker.io/astral/uv:python${PYTHON_VERSION}-bookworm

ENV DEBIAN_FRONTEND=noninteractive

# Core OS/toolbox deps for agent workflows
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl git openssh-client bash \
    ripgrep fd-find fzf tree less jq \
    gawk sed patch diffutils findutils \
    unzip zip tar xz-utils bzip2 gzip \
    pdfgrep poppler-utils \
    procps psmisc lsof strace \
    iproute2 dnsutils netcat-openbsd openssl \
    build-essential pkg-config cmake ninja-build \
    libssl-dev libffi-dev zlib1g-dev \
    ncurses-term ncurses-bin \
    libglib2.0-0 \
  && rm -rf /var/lib/apt/lists/* \
  && ln -sf /usr/bin/fdfind /usr/local/bin/fd

# Node.js 24 LTS (official binary, no third-party repo)
RUN curl -fsSL https://nodejs.org/dist/v24.13.1/node-v24.13.1-linux-x64.tar.xz \
    | tar -xJ --strip-components=1 -C /usr/local

# Install Claude Code into the image
RUN bash -lc 'set -euo pipefail; \
    export HOME=/opt/claude-staging; \
    export PATH="$HOME/.local/bin:$PATH"; \
    mkdir -p "$HOME"; \
    curl -fsSL https://claude.ai/install.sh | bash; \
    CLAUDE_LINK="$HOME/.local/bin/claude"; \
    test -x "$CLAUDE_LINK"; \
    CLAUDE_REAL="$(readlink -f "$CLAUDE_LINK")"; \
    install -m 0755 "$CLAUDE_REAL" /usr/local/bin/claude; \
    rm -rf /opt/claude-staging'

# Writable dirs for arbitrary runtime UID (no sudo)
RUN mkdir -p /home/claude /venv /uv-cache /uv-tools /uv-bin \
  && chmod 0777 /home/claude /venv /uv-cache /uv-tools /uv-bin

ENV HOME=/home/claude

ENV UV_PROJECT_ENVIRONMENT=/venv
ENV UV_CACHE_DIR=/uv-cache

# uv tool install locations (so CLIs are always on PATH without sudo)
ENV UV_TOOL_DIR=/uv-tools
ENV UV_TOOL_BIN_DIR=/uv-bin
ENV PATH="/uv-bin:/home/claude/.local/bin:/usr/local/bin:/usr/bin:/bin"

# Python CLI toolbox via uv
RUN uv tool install ruff \
 && uv tool install ty@latest \
 && uv tool install prek

ENTRYPOINT ["claude"]
